<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Disnord Chat</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="flex-center">
    
    <div class="glass-panel" style="width: 95vw; height: 90vh; max-width: 1200px; padding: 0; display: flex; flex-direction: column; overflow: hidden; position:relative;">
        
        <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; text-shadow: 0 0 10px var(--primary);">DISNORD <span style="font-size:0.6em; color:var(--primary);">LIVE</span></h2>
            <button class="btn" style="width:auto; padding:5px 10px;" onclick="location.href='/settings'">⚙️</button>
        </div>

        <div id="messages" style="flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth;"></div>

        <div style="padding: 15px; background: rgba(0,0,0,0.2); display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <input type="text" id="msgInput" class="input-field" placeholder="Nachricht schreiben..." style="margin:0;" onkeypress="if(event.key==='Enter') send()">
            <button class="btn" style="width: auto; padding: 0 20px;" onclick="send()">➤</button>
        </div>

    </div>

    <div class="profile-card" onclick="location.href='/settings'">
        <div class="profile-avatar" id="p-avatar">?</div>
        <div class="profile-info">
            <span class="profile-name" id="p-name">Laden...</span>
            <span class="profile-status">Online ●</span>
        </div>
    </div>

    <script>
        const socket = io();
        const username = localStorage.getItem('disnord_user');
        
        // Sicherheits-Check: Nicht eingeloggt? Raus hier!
        if(!username) location.href = '/login';

        // Profil Daten setzen
        document.getElementById('p-name').innerText = username;
        document.getElementById('p-avatar').innerText = username.charAt(0).toUpperCase();

        const messagesDiv = document.getElementById('messages');

        // Nachrichten empfangen
        socket.on('history', (msgs) => {
            messagesDiv.innerHTML = '';
            msgs.forEach(addMessage);
            scrollToBottom();
        });

        socket.on('chat-message', (msg) => {
            addMessage(msg);
            scrollToBottom();
        });

        function send() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if(!text) return;
            
            socket.emit('chat-message', {
                user: username,
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
            input.value = '';
        }

        function addMessage(msg) {
            const div = document.createElement('div');
            const isMe = msg.user === username;
            
            div.style.cssText = `
                background: ${isMe ? 'rgba(0, 242, 254, 0.15)' : 'rgba(255,255,255,0.05)'};
                padding: 10px 15px;
                border-radius: ${isMe ? '15px 15px 0 15px' : '15px 15px 15px 0'};
                align-self: ${isMe ? 'flex-end' : 'flex-start'};
                max-width: 80%;
                border: 1px solid ${isMe ? 'rgba(0, 242, 254, 0.3)' : 'rgba(255,255,255,0.1)'};
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            `;
            
            div.innerHTML = `
                <div style="font-size:0.75em; color:${isMe ? 'var(--primary)' : '#aaa'}; margin-bottom:3px; display:flex; justify-content:space-between; gap:10px;">
                    <b>${msg.user}</b> <span>${msg.time}</span>
                </div>
                <div style="color:white; word-break:break-word;">${msg.text}</div>
            `;
            messagesDiv.appendChild(div);
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>